<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${pageTitle}">Luvo - Redefining Travel Experiences</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="nav-wrapper">
                <a th:href="@{/}" class="logo">Luvo</a>
                <ul class="nav-menu">
                    <li><a th:href="@{/explore}">Explore</a></li>
                    <li><a th:href="@{/family-planner}">Family Planner</a></li>
                    <li><a th:href="@{/itinerary}">Itinerary</a></li>
                    <li><a th:href="@{/business}">Business</a></li>
                    <li><a th:href="@{/guide}">Guide</a></li>
                    <li><a th:href="@{/admin}">Admin</a></li>
                </ul>
                <div class="nav-actions">
                    <a th:href="@{/login}" class="btn btn-login">Login</a>
                    <a th:href="@{/signup}" class="btn btn-signup">Sign Up</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="hero">
        <div class="container">
            <h1 class="hero-title">Redefining Travel Experiences</h1>
            <p class="hero-subtitle">
                Explore destinations, compare options, and plan<br>
                itineraries â€” all in one place.
            </p>
            
            <div class="search-bar">
                <button class="tab-btn active">Explore Trips</button>
                <input id="homeDestination" type="text" placeholder="Select..." class="search-input">
                <button id="homeSearchBtn" class="btn btn-search">Search</button>
            </div>
            <div id="homeResults" class="home-results mt-3"></div>
        </div>
    </section>

    <script>
        const API_URL = '/explore/api';

        document.getElementById('homeSearchBtn').addEventListener('click', async () => {
            let destination = document.getElementById('homeDestination').value || '';
            const raw = destination.trim();
            let type = '';

            // detect category keywords like 'hotel', 'airbnb', or 'activity' in the typed text
            const lowered = raw.toLowerCase();
            if (lowered.includes('hotel')) {
                type = 'Hotel';
                destination = raw.replace(/hotel/ig, '').trim();
            } else if (lowered.includes('airbnb')) {
                type = 'Airbnb';
                destination = raw.replace(/airbnb/ig, '').trim();
            } else if (lowered.includes('activity')) {
                type = 'Activity';
                destination = raw.replace(/activity/ig, '').trim();
            }

            let url = API_URL + '?';
            if (destination) url += `destination=${encodeURIComponent(destination)}&`;
            if (type) url += `type=${encodeURIComponent(type)}`;

            try {
                const res = await fetch(url);
                const trips = await res.json();
                renderHomeResults(trips);
            } catch (e) {
                console.error('Home search error', e);
                document.getElementById('homeResults').innerHTML = '<p class="text-danger">Unable to load results.</p>';
            }
        });

        function renderHomeResults(trips) {
            const c = document.getElementById('homeResults');
            if (!trips || trips.length === 0) {
                c.innerHTML = '<p>No results found. Try a different term or visit Explore.</p>';
                return;
            }

            c.innerHTML = '<div class="cards-container">' + trips.map(t => {
                const priceRange = t.priceRange ? `<p style="margin:4px 0;color:#444">${t.priceRange}</p>` : '';
                const price = (t.price && t.price > 0) ? `<p style="font-weight:600">$${t.price}</p>` : '';
                const bookBtn = (t.type && t.type.toLowerCase()==='activity' && t.metaId)
                    ? `<button class="btn btn-sm btn-primary" onclick="bookActivityHome('${t.metaId}', this)">Book</button>`
                    : '';
                return `\
                <div class="card" style="display:inline-block;width:220px;margin:8px;padding:8px;vertical-align:top">\
                    <img src="${t.imageUrl || '/images/placeholder.png'}" style="width:100%;height:120px;object-fit:cover">\
                    <h4 style="margin:8px 0">${t.title}</h4>\
                    ${priceRange}\
                    ${price}\
                    <p style="margin:0;color:#666">${t.details || ''}</p>\
                    ${bookBtn}\
                </div>`;
            }).join('') + '</div>';
        }

        async function bookActivityHome(tourId, btn) {
            try {
                btn.disabled = true;
                const res = await fetch(`/guide/api/${tourId}/book`, { method: 'POST' });
                const text = await res.text();
                if (text === 'BOOKED') {
                    btn.textContent = 'Booked';
                } else if (text === 'NO_SEATS') {
                    btn.textContent = 'Full';
                } else {
                    btn.textContent = 'Error';
                    btn.disabled = false;
                }
            } catch (e) {
                console.error(e);
                btn.textContent = 'Error';
                btn.disabled = false;
            }
        }
    </script>

    <!-- Role Cards Section -->
    <section class="roles">
        <div class="container">
            <h2 class="section-title">Start by role</h2>
            <div class="role-grid">
                <!-- Student Explorer Card -->
                <div class="role-card card-blue">
                    <h3 class="role-title">Student Explorer</h3>
                    <p class="role-description">Find affordable trips and compare options</p>
                    <a th:href="@{/explore}" class="btn btn-role">Start Exploring</a>
                </div>

                <!-- Family Planner Card -->
                <div class="role-card card-yellow">
                    <h3 class="role-title">Family Planner</h3>
                    <p class="role-description">Track budgets and collaborate with family</p>
                    <a th:href="@{/family-planner}" class="btn btn-role btn-planner">Open Planner</a>
                </div>

                <!-- Local Business Card -->
                <div class="role-card card-green">
                    <h3 class="role-title">Local Business</h3>
                    <p class="role-description">List services travelers can book</p>
                    <a th:href="@{/business}" class="btn btn-role">Manage Listings</a>
                </div>
            </div>
        </div>
    </section>
</body>
</html>